<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Pricing Transparency Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
        }
        
        .data-limitation-alert {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .price-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        
        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .search-section {
            background-color: #f8f9fa;
            padding: 2rem 0;
        }
        
        .price-tag {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .cash-price {
            color: #28a745;
        }
        
        .gross-charge {
            color: #dc3545;
        }
        
        .price-na {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-hospital"></i> Hospital Pricing Tool</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#search">Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#compare">Compare</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="display-4 fw-bold mb-4">Hospital Pricing Transparency Tool</h1>
                    <p class="lead mb-4">Compare hospital cash prices and standard charges for medical procedures. 
                    Get transparency into healthcare costs before you need care.</p>
                    <div class="d-flex justify-content-center gap-3">
                        <span class="badge bg-light text-dark fs-6">Cash Prices Available</span>
                        <span class="badge bg-light text-dark fs-6">Cross-Hospital Comparison</span>
                        <span class="badge bg-light text-dark fs-6">Real Transparency Data</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Limitations Notice -->
    <div class="container my-4">
        <div class="alert data-limitation-alert">
            <h5 class="alert-heading"><i class="fas fa-info-circle"></i> Understanding Healthcare Pricing Data</h5>
            <p class="mb-2"><strong>What's Available:</strong> Cash prices (self-pay) and hospital standard charges (gross charges)</p>
            <p class="mb-2"><strong>What's NOT Available:</strong> Insurance negotiated rates are not published in transparency files</p>
            <p class="mb-0"><small class="text-muted">Hospital transparency files contain placeholder text for insurance rates, stating "The modified price is presented in the standard charge value." Your actual cost with insurance will likely differ from these published prices.</small></p>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="card-title text-center mb-4">Search Medical Procedures</h3>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control" id="procedureSearch" 
                                       placeholder="Search procedures (e.g., MRI, echocardiogram, blood test)">
                                <button class="btn btn-primary" type="button" onclick="searchProcedures()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">Search by procedure name, description, or medical code</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="container my-5">
        <div id="searchResults" style="display: none;">
            <h4 class="mb-4">Search Results</h4>
            <div id="proceduresList" class="row"></div>
        </div>

        <div id="pricingDetails" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 id="selectedProcedureName"></h4>
                <button class="btn btn-outline-secondary" onclick="backToSearch()">
                    <i class="fas fa-arrow-left"></i> Back to Search
                </button>
            </div>
            
            <div id="pricingChart" class="mb-4"></div>
            
            <div class="row" id="hospitalPricing"></div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="container my-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Database Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row" id="statsContent">
                    <div class="col-12 text-center">
                        <small class="text-muted">Loading statistics...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6>About This Tool</h6>
                    <p class="small mb-0">This tool provides access to hospital pricing transparency data as required by federal regulations. 
                    The data comes directly from hospital-published pricing files and reflects cash prices and standard charges, 
                    but does not include actual insurance negotiated rates.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="small mb-0">Data sources: Hospital transparency files</p>
                    <p class="small mb-0">Last updated: <span id="lastUpdated">Recent</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    
    <script>
        let currentProcedures = [];
        
        // Load statistics on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            
            // Add enter key support for search
            document.getElementById('procedureSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchProcedures();
                }
            });
        });
        
        function loadStatistics() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const stats = data.statistics;
                    const quality = data.data_quality;
                    
                    document.getElementById('statsContent').innerHTML = `
                        <div class="col-md-3 text-center">
                            <div class="h3 text-primary">${stats.hospitals.toLocaleString()}</div>
                            <div class="small text-muted">Hospitals</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-success">${stats.procedures.toLocaleString()}</div>
                            <div class="small text-muted">Procedures</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-info">${stats.pricing_records.toLocaleString()}</div>
                            <div class="small text-muted">Pricing Records</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-warning">${stats.shared_procedures.toLocaleString()}</div>
                            <div class="small text-muted">Comparable Procedures</div>
                        </div>
                        <div class="col-12 mt-3">
                            <small class="text-muted">
                                Cash price coverage: ${quality.cash_price_coverage} | 
                                Gross charge coverage: ${quality.gross_charge_coverage}
                            </small>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    document.getElementById('statsContent').innerHTML = `
                        <div class="col-12 text-center text-muted">
                            <small>Unable to load statistics</small>
                        </div>
                    `;
                });
        }
        
        function searchProcedures() {
            const searchTerm = document.getElementById('procedureSearch').value.trim();
            if (!searchTerm) return;
            
            fetch(`/api/procedures?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    currentProcedures = data;
                    displayProcedures(data);
                })
                .catch(error => {
                    console.error('Error searching procedures:', error);
                    alert('Error searching procedures. Please try again.');
                });
        }
        
        function displayProcedures(procedures) {
            const container = document.getElementById('proceduresList');
            
            if (procedures.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No procedures found. Try a different search term.</p>
                    </div>
                `;
            } else {
                container.innerHTML = procedures.map(procedure => `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card price-card h-100" onclick="viewPricing(${procedure.id})">
                            <div class="card-body">
                                <h6 class="card-title">${procedure.name}</h6>
                                ${procedure.code ? `<p class="small text-muted mb-2">Code: ${procedure.code}</p>` : ''}
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary">${procedure.hospital_count} hospital(s)</span>
                                    <small class="text-primary">View Pricing →</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('pricingDetails').style.display = 'none';
        }
        
        function viewPricing(procedureId) {
            fetch(`/api/pricing/${procedureId}`)
                .then(response => response.json())
                .then(data => {
                    displayPricingDetails(data);
                })
                .catch(error => {
                    console.error('Error loading pricing:', error);
                    alert('Error loading pricing data. Please try again.');
                });
        }
        
        function displayPricingDetails(data) {
            document.getElementById('selectedProcedureName').textContent = data.procedure.name;
            
            // Display hospital pricing cards
            const hospitalContainer = document.getElementById('hospitalPricing');
            hospitalContainer.innerHTML = data.pricing_by_hospital.map(item => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card price-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${item.hospital.name}</h6>
                            ${item.hospital.location ? `<p class="small text-muted mb-3">${item.hospital.location}</p>` : ''}
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-medium">Cash Price:</span>
                                    <span class="price-tag cash-price">
                                        ${item.pricing.cash_price ? `$${item.pricing.cash_price.toLocaleString()}` : '<span class="price-na">Not Available</span>'}
                                    </span>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-medium">Gross Charge:</span>
                                    <span class="price-tag gross-charge">
                                        ${item.pricing.gross_charge ? `$${item.pricing.gross_charge.toLocaleString()}` : '<span class="price-na">Not Available</span>'}
                                    </span>
                                </div>
                                
                                ${item.pricing.price_range.min && item.pricing.price_range.max ? `
                                    <div class="mt-2 pt-2 border-top">
                                        <small class="text-muted">
                                            Range: $${item.pricing.price_range.min.toLocaleString()} - $${item.pricing.price_range.max.toLocaleString()}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${item.last_updated ? `
                                <small class="text-muted">Updated: ${new Date(item.last_updated).toLocaleDateString()}</small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Load and display chart
            loadPricingChart(data.procedure.id);
            
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('pricingDetails').style.display = 'block';
        }
        
        function loadPricingChart(procedureId) {
            fetch(`/api/chart/${procedureId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.chart) {
                        Plotly.newPlot('pricingChart', JSON.parse(data.chart).data, JSON.parse(data.chart).layout, {
                            responsive: true,
                            displayModeBar: false
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading chart:', error);
                    document.getElementById('pricingChart').innerHTML = `
                        <div class="alert alert-warning">
                            <small>Unable to load pricing chart</small>
                        </div>
                    `;
                });
        }
        
        function backToSearch() {
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('pricingDetails').style.display = 'none';
        }
    </script>
</body>
</html> 